<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Crastina Timer</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#101016">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="icon" href="icon-128.png" sizes="128x128">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" type="image/png" sizes="48x48" href="favicon-48.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    :root {
      --fg:#e8e8ee; --muted:#a3a3b5;
      --start-d: clamp(120px, 26vw, 180px); /* smaller */
      --cream: #f1f0cc;
      --brand-green: #0a372f;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0;
      background:
        radial-gradient(1100px 780px at 50% 0%, #141419 0%, #0e0e13 55%, #0a0a0f 100%);
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial;
      display:grid; place-items:center; padding:18px;
      overflow-x:hidden;
    }
    /* Container without card background (full minimal) */
    .wrap { width:min(1100px, 100%); padding:8px 6px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .left-header { display:flex; align-items:center; gap:10px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.05); color:#d6d7ff; font-weight:700; font-size:12px; letter-spacing:.3px; }
    .counter { background:rgba(214,255,229,.08); border:1px solid rgba(214,255,229,.16); color:#d6ffe5; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; }

    .grid { display:grid; grid-template-columns: 1.1fr 0.9fr; gap:22px; align-items:stretch; }
    @media (max-width: 740px) { .grid { grid-template-columns: 1fr; gap:16px; } .shortcuts { order: -1; } }

    /* Panels removed -> use spacing only */
    .display { text-align:center; padding:6px 8px; }
    .time { font-size: clamp(56px, 12vw, 120px); font-weight:900; letter-spacing:2px; line-height:1; text-shadow: 0 6px 24px rgba(0,0,0,.45); }
    .status { margin-top:8px; font-size:13px; color:var(--muted); min-height:19px; }

    .inputs { display:flex; gap:12px; align-items:end; justify-content:center; flex-wrap:wrap; margin-top:14px; }
    .field label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    .field input[type="number"] {
      width:120px; padding:12px 14px; border-radius:14px;
      border:1px solid #2a2a3a; background:#0f0f14; color:#ededf6; font-size:16px;
    }

    .controls { margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:14px; }
    .big-start {
      width: var(--start-d); height: var(--start-d);
      border-radius: 9999px;
      display:grid; place-items:center;
      font-size: clamp(16px, 4.4vw, 22px);
      font-weight: 900; letter-spacing:.6px;
      color: #f9f9f9; /* white text */
      background: linear-gradient(145deg, #1c1c1f 0%, #2a2a2e 100%);
      border: 1px solid rgba(255,255,255,.22);
      cursor: pointer;
      box-shadow: 0 10px 28px rgba(0,0,0,.28), inset 0 -6px 12px rgba(0,0,0,.18);
      text-shadow: 0 1px 2px rgba(0,0,0,.4);
      transition: transform .06s ease, box-shadow .2s ease, filter .2s;
      user-select: none;
    }
    .big-start:active { transform: translateY(1px) scale(.99); }

    /* Shortcuts in 2x2 grid, keep block style */
    .shortcuts { display:grid; grid-template-columns: 1fr 1fr; gap:12px; padding:6px 8px; }
    .sbtn {
      background: linear-gradient(145deg, #1b1b1f 0%, #2a2a33 100%);
      border: 1px solid #333642;
      box-shadow: inset 0 1px 3px rgba(255,255,255,0.06), 0 4px 14px rgba(0,0,0,0.35);
      color: #f1f0cc;
      border-radius:16px; padding:18px 16px;
      font-weight:800; font-size:18px; text-align:center;
      transition: transform .08s ease, box-shadow .3s ease, filter .3s ease;
      min-height: 96px; display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    .sbtn small { display:block; color:#c7c8d6; font-weight:600; font-size:12px; margin-top:6px; letter-spacing:.3px; }
    .sbtn:hover { filter: brightness(1.12); transform: translateY(-1px); box-shadow: inset 0 1px 3px rgba(255,255,255,0.08), 0 6px 18px rgba(0,0,0,0.4); }

    footer { margin-top:18px; text-align:center; color:#8b8ba0; font-size:12px; }

    /* Done area - minimal, only brand sentence */
    .done-wrap { margin-top:16px; min-height: 28px; }
    .done-line {
      margin-top: 8px;
      font-size: clamp(18px, 3.4vw, 22px);
      color: var(--cream);
      letter-spacing: .4px;
      opacity: 0; transform: translateY(10px);
      font-weight: 700;
      text-shadow: 0 1px 1px rgba(0,0,0,.25);
      text-align:center;
    }
    .show .done-line { animation: fadeUp 1.5s ease forwards; }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="Crastina 簡易倒數計時器">
    <header>
      <div class="left-header">
        <div class="pill">⏱️ Crastina Timer v2.8</div>
        <div class="counter" id="todayCount">今天完成：0 次</div>
      </div>
      <button class="sbtn" id="soundTestBtn" title="測試提示音">試聽提示音🔊</button>
    </header>

    <div class="grid">
      <section class="display" aria-live="polite">
        <div class="time" id="timeText">00:03:00</div>
        <div class="status" id="statusText">待命中</div>

        <div class="inputs">
          <div class="field">
            <label for="mins">分鐘</label>
            <input id="mins" type="number" min="0" max="999" step="1" value="3" />
          </div>
          <div class="field">
            <label for="secs">秒</label>
            <input id="secs" type="number" min="0" max="59" step="1" value="0" />
          </div>
        </div>

        <div class="controls">
          <button class="big-start" id="startPauseBtn" aria-label="開始或暫停">CRASTINA</button>
        </div>

        <div class="done-wrap" id="doneWrap">
          <div class="done-line">為呼吸而暫停努力，不是退後，而是重新與自己對齊。</div>
        </div>
      </section>

      <aside class="shortcuts" aria-label="快捷鍵">
        <button class="sbtn" data-min="3" data-sec="0">專注 3 分鐘<small>Quick focus</small></button>
        <button class="sbtn" data-min="5" data-sec="0">小休 5 分鐘<small>Short break</small></button>
        <button class="sbtn" data-min="15" data-sec="0">深休 15 分鐘<small>Deep rest</small></button>
        <button class="sbtn" data-min="30" data-sec="0">專注 30 分鐘<small>Long focus</small></button>
      </aside>
    </div>

    <footer>
      <div>提示：在 iPhone/Android 的瀏覽器選單中選「加入主畫面」，就像 App 一樣使用。</div>
    </footer>
  </div>

<script>
(function(){
  const timeText = document.getElementById('timeText');
  const statusText = document.getElementById('statusText');
  const mins = document.getElementById('mins');
  const secs = document.getElementById('secs');
  const startPauseBtn = document.getElementById('startPauseBtn');
  const soundTestBtn = document.getElementById('soundTestBtn');
  const doneWrap = document.getElementById('doneWrap');
  const todayCountEl = document.getElementById('todayCount');

  function todayKey() {
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `crastina_count_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function loadTodayCount(){
    let cnt = parseInt(localStorage.getItem(todayKey()) || '0', 10);
    if (isNaN(cnt)) cnt = 0;
    todayCountEl.textContent = `今天完成：${cnt} 次`;
    return cnt;
  }
  function bumpTodayCount(){
    const key = todayKey();
    let cnt = parseInt(localStorage.getItem(key) || '0', 10);
    if (isNaN(cnt)) cnt = 0;
    cnt += 1;
    localStorage.setItem(key, String(cnt));
    todayCountEl.textContent = `今天完成：${cnt} 次`;
  }
  loadTodayCount();

  // Shortcuts: set time and auto-start
  document.querySelectorAll('.sbtn[data-min]').forEach(btn => {
    btn.addEventListener('click', () => {
      mins.value = btn.dataset.min; secs.value = btn.dataset.sec;
      total = toSeconds(mins.value, secs.value);
      persist(); hideDone();
      start(true); // auto-start fresh
    });
  });

  let total = toSeconds(mins.value, secs.value);
  let timer = null;
  let running = false;

  const saved = localStorage.getItem('crastina_timer_last_v28');
  if (saved) {
    try {
      const {m, s} = JSON.parse(saved);
      mins.value = clamp(parseInt(m)||0, 0, 999);
      secs.value = clamp(parseInt(s)||0, 0, 59);
      total = toSeconds(mins.value, secs.value);
      render();
    } catch(_){}
  } else { persist(); }

  mins.addEventListener('change', () => { mins.value = clamp(mins.value,0,999); total = toSeconds(mins.value, secs.value); render(); persist(); hideDone(); });
  secs.addEventListener('change', () => { secs.value = clamp(secs.value,0,59); total = toSeconds(mins.value, secs.value); render(); persist(); hideDone(); });

  startPauseBtn.addEventListener('click', () => { if (!running) start(); else pause(); });
  soundTestBtn.addEventListener('click', () => beep());

  function start(fresh=false){
    hideDone();
    if (fresh) { total = toSeconds(mins.value, secs.value); }
    if (total <= 0) total = toSeconds(mins.value, secs.value);
    clearInterval(timer);
    running = true;
    startPauseBtn.textContent = '暫停';
    statusText.textContent = '倒數中…';
    tick(); timer = setInterval(tick, 1000);
  }
  function pause(){
    running = false;
    startPauseBtn.textContent = 'CRASTINA';
    statusText.textContent = '已暫停';
    if (timer) clearInterval(timer);
  }
  function tick(){
    if (total <= 0){
      pause();
      statusText.textContent = '完成';
      render();
      try { navigator.vibrate && navigator.vibrate([180,80,180]); } catch(_){}
      beep();
      bumpTodayCount();
      showDone();
      return;
    }
    total -= 1; render();
  }
  function render(hint){
    timeText.textContent = format(total);
    if (hint) statusText.textContent = hint;
    document.title = timeText.textContent + ' • Crastina Timer';
  }

  function toSeconds(m,s){ m = clamp(parseInt(m)||0,0,999); s = clamp(parseInt(s)||0,0,59); return m*60 + s; }
  function format(sec){ const m = Math.floor(sec/60); const s = sec % 60; const hh = Math.floor(m/60); const mm = m%60; if (hh>0) return `${pad(hh)}:${pad(mm)}:${pad(s)}`; return `${pad(mm)}:${pad(s)}`; }
  function pad(n){ return String(n).padStart(2,'0'); }
  function clamp(n,min,max){ n = Number(n); if (isNaN(n)) return min; return Math.max(min, Math.min(max, n)); }
  function persist(){ localStorage.setItem('crastina_timer_last_v28', JSON.stringify({m: mins.value, s: secs.value})); }

  // Double-cycle chime with 0.4s gap
  function beep(){
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const now = ctx.currentTime;
    const pattern = [0, 0.18, 0.36, 0.9, 1.08, 1.26];
    pattern.forEach((t, i) => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      const f = 880 + (i % 3) * 120;
      o.type = 'sine';
      o.frequency.value = f;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, now + t);
      g.gain.exponentialRampToValueAtTime(0.25, now + t + 0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, now + t + 0.14);
      o.start(now + t); o.stop(now + t + 0.3);
    });
  }

  function showDone(){ doneWrap.classList.add('show'); }
  function hideDone(){ doneWrap.classList.remove('show'); }

  if ('Notification' in window && Notification.permission === 'default') {
    setTimeout(() => Notification.requestPermission().catch(()=>{}), 1200);
  }
})();
</script>
</body>
</html>
