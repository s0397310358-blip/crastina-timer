<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Crastina Timer v3.2</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#101016">
  <style>
    :root {
      --fg:#e8e8ee; --muted:#a3a3b5;
      --bg1:#141419; --bg2:#0e0e13; --bg3:#0a0a0f;
      --start-d: clamp(120px, 26vw, 180px);
      --cream: #f1f0cc;
      --btn-dark-1:#1c1c1f; --btn-dark-2:#2a2a2e;
      --card-1:#1b1b1f; --card-2:#2a2a33; --card-b:#333642; --card-t:#f1f0cc;
      --chip-bg:#17171c; --chip-bd:#2b2b36; --chip-t:#dfe4ff;
      --accent:#7fd7c4;
    }
    [data-mode="rest"] {
      --fg:#1a1f27; --muted:#6b7380;
      --bg1:#f5f5f2; --bg2:#ecebe6; --bg3:#e3e1da;
      --btn-dark-1:#e7e8ea; --btn-dark-2:#cfd3d8;
      --card-1:#f0f1ee; --card-2:#e2e5e2; --card-b:#d4d8d6; --card-t:#2a343a;
      --chip-bg:#f1f2ef; --chip-bd:#d9dddb; --chip-t:#2a343a;
    }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body {
      margin:0;
      background: radial-gradient(1100px 780px at 50% 0%, var(--bg1) 0%, var(--bg2) 55%, var(--bg3) 100%);
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Helvetica Neue", Arial;
      display:grid; place-items:center; padding:18px;
      overflow-x:hidden; transition: background .6s ease, color .6s ease;
    }
    .wrap { width:min(1100px, 100%); padding:8px 6px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .left-header { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.05); color:#d6d7ff; font-weight:700; font-size:12px; letter-spacing:.3px; }
    [data-mode="rest"] .pill { background:rgba(0,0,0,.06); color:#2e3b55; }
    .counters { display:flex; gap:8px; flex-wrap:wrap; }
    .counter { background:rgba(214,255,229,.08); border:1px solid rgba(214,255,229,.16); color:#d6ffe5; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; }
    [data-mode="rest"] .counter { background:rgba(10,55,47,.08); border-color:rgba(10,55,47,.16); color:#0a372f; }

    .mode-toggle { display:flex; gap:8px; }
    .mode-btn {
      border-radius:999px; padding:8px 12px; font-weight:800; font-size:12px; letter-spacing:.4px;
      border:1px solid rgba(255,255,255,.18); background:linear-gradient(145deg, #1b1b1f, #2a2a33); color:#e9ebff;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      cursor:pointer; transition: filter .2s, transform .06s;
    }
    .mode-btn:active{ transform:translateY(1px); }
    .mode-btn.active { outline:2px solid var(--accent); }
    [data-mode="rest"] .mode-btn { border-color:rgba(0,0,0,.12); background:linear-gradient(145deg, #eceeec, #dde1e0); color:#1f2a30; }
    [data-mode="rest"] .mode-btn.active { outline:2px solid #859aa1; }

    .grid { display:grid; grid-template-columns: 1.1fr 0.9fr; gap:22px; align-items:stretch; }
    @media (max-width: 860px) { .grid { grid-template-columns: 1fr; gap:16px; } .shortcuts { order: -1; } }

    .display { text-align:center; padding:6px 8px; }
    .time { font-size: clamp(56px, 12vw, 120px); font-weight:900; letter-spacing:2px; line-height:1; text-shadow: 0 6px 24px rgba(0,0,0,.35); }
    [data-mode="rest"] .time { text-shadow: 0 3px 10px rgba(0,0,0,.08); }
    .status { margin-top:8px; font-size:13px; color:var(--muted); min-height:19px; }

    .inputs { display:flex; gap:12px; align-items:end; justify-content:center; flex-wrap:wrap; margin-top:14px; }
    .field label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    .field input[type="number"] {
      width:120px; padding:12px 14px; border-radius:14px;
      border:1px solid #2a2a3a; background:#0f0f14; color:#ededf6; font-size:16px;
      transition: background .4s ease, color .4s ease, border-color .4s ease;
    }
    [data-mode="rest"] .field input[type="number"] { background:#f6f7f4; color:#0f1520; border-color:#cfd4da; }

    .controls { margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:14px; }
    .big-start {
      width: var(--start-d); height: var(--start-d);
      border-radius: 9999px;
      display:grid; place-items:center;
      font-size: clamp(16px, 4.4vw, 22px);
      font-weight: 900; letter-spacing:.6px;
      color: #f9f9f9;
      background: linear-gradient(145deg, var(--btn-dark-1) 0%, var(--btn-dark-2) 100%);
      border: 1px solid rgba(255,255,255,.22);
      cursor: pointer;
      box-shadow: 0 10px 28px rgba(0,0,0,.28), inset 0 -6px 12px rgba(0,0,0,.18);
      text-shadow: 0 1px 2px rgba(0,0,0,.4);
      transition: transform .06s ease, box-shadow .2s ease, filter .2s;
      user-select: none;
    }
    .big-start:active { transform: translateY(1px) scale(.99); }

    /* Shortcuts: 5 / 8 / 15 / 30 */
    .shortcuts { 
      display:grid; 
      grid-template-columns: repeat(2, 1fr);
      gap:12px; padding:6px 8px; 
    }
    @media (min-width: 640px){ .shortcuts { grid-template-columns: repeat(4, 1fr);} }
    .sbtn {
      background: linear-gradient(145deg, var(--card-1) 0%, var(--card-2) 100%);
      border: 1px solid var(--card-b);
      box-shadow: inset 0 1px 3px rgba(255,255,255,0.06), 0 4px 14px rgba(0,0,0,0.25);
      color: var(--card-t);
      border-radius:16px; padding:22px 16px;
      font-weight:900; font-size:28px; text-align:center; letter-spacing: .6px;
      transition: transform .08s ease, box-shadow .3s ease, filter .3s ease;
      min-height: 96px; display:flex; align-items:center; justify-content:center;
    }
    .sbtn:hover { filter: brightness(1.08); transform: translateY(-1px); box-shadow: inset 0 1px 3px rgba(255,255,255,0.08), 0 6px 18px rgba(0,0,0,0.35); }

    /* Favorites */
    .fav-wrap { margin-top:10px; padding:6px 8px; }
    .fav-title { font-size:12px; color:var(--muted); margin-bottom:8px; display:flex; align-items:center; gap:8px; }
    .fav-controls { display:flex; gap:8px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; background:var(--chip-bg);
      border:1px solid var(--chip-bd); color:var(--chip-t);
      font-weight:800; font-size:14px; letter-spacing:.3px; cursor:pointer;
      transition: filter .2s, transform .06s;
    }
    .chip:active { transform: translateY(1px); }
    .chip .rm { font-weight:900; opacity:.7; }
    .chip .rm:hover { opacity: 1; }
    .fav-input { width:120px; padding:10px 12px; border-radius:999px; border:1px solid var(--chip-bd); background:transparent; color:var(--fg); }
    .fav-btn { padding:10px 12px; border-radius:999px; border:1px solid var(--chip-bd); background:transparent; color:var(--fg); font-weight:800; cursor:pointer; }
    .switch { display:inline-flex; align-items:center; gap:8px; }
    .switch input { width:18px; height:18px; }

    footer { margin-top:18px; text-align:center; color:#8b8ba0; font-size:12px; }

    .done-wrap { margin-top:16px; min-height: 28px; }
    .done-line {
      margin-top: 8px;
      font-size: clamp(18px, 3.4vw, 22px);
      color: var(--cream);
      letter-spacing: .4px;
      opacity: 0; transform: translateY(10px);
      font-weight: 700;
      text-shadow: 0 1px 1px rgba(0,0,0,.25);
      text-align:center;
    }
    .show .done-line { animation: fadeUp 1.5s ease forwards; }
    @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body data-mode="focus">
  <div class="wrap" role="application" aria-label="Crastina 雙模式計時儀式">
    <header>
      <div class="left-header">
        <div class="pill">⏱️ Crastina Timer v3.2</div>
        <div class="counters">
          <div class="counter" id="focusCount">專注：0 次</div>
          <div class="counter" id="restCount">休息：0 次</div>
        </div>
      </div>
      <div class="mode-toggle">
        <button class="mode-btn active" id="focusModeBtn">專注模式</button>
        <button class="mode-btn" id="restModeBtn">休息模式</button>
        <label class="switch" title="完成時震動（若裝置支援）">
          <input type="checkbox" id="vibrateToggle">
          <span>完成時震動</span>
        </label>
        <button class="mode-btn" id="soundTestBtn" title="測試提示音">試音🔊</button>
      </div>
    </header>

    <div class="grid">
      <section class="display" aria-live="polite">
        <div class="time" id="timeText">00:05:00</div>
        <div class="status" id="statusText">待命中</div>

        <div class="inputs">
          <div class="field">
            <label for="mins">分鐘</label>
            <input id="mins" type="number" min="0" max="999" step="1" value="5" />
          </div>
          <div class="field">
            <label for="secs">秒</label>
            <input id="secs" type="number" min="0" max="59" step="1" value="0" />
          </div>
        </div>

        <div class="controls">
          <button class="big-start" id="startPauseBtn" aria-label="開始或暫停">CRASTINA</button>
        </div>

        <div class="done-wrap" id="doneWrap">
          <div class="done-line">為呼吸而暫停努力，不是退後，而是重新與自己對齊。</div>
        </div>
      </section>

      <aside aria-label="快捷鍵">
        <div class="shortcuts" id="shortcuts"></div>

        <div class="fav-wrap">
          <div class="fav-title">自訂常用（點擊使用；✕ 移除）</div>
          <div class="fav-controls">
            <input class="fav-input" id="favInput" type="number" placeholder="分鐘" min="1" max="240" />
            <button class="fav-btn" id="favAddBtn">加入</button>
            <div id="favChips"></div>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      <div>提示：將此頁「加入主畫面」即可像 App 一樣使用。</div>
    </footer>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const body = document.body;
  const timeText = $('#timeText');
  const statusText = $('#statusText');
  const mins = $('#mins');
  const secs = $('#secs');
  const startPauseBtn = $('#startPauseBtn');
  const soundTestBtn = $('#soundTestBtn');
  const doneWrap = $('#doneWrap');
  const focusCountEl = $('#focusCount');
  const restCountEl = $('#restCount');
  const focusModeBtn = $('#focusModeBtn');
  const restModeBtn = $('#restModeBtn');
  const shortcutsWrap = $('#shortcuts');
  const favInput = $('#favInput');
  const favAddBtn = $('#favAddBtn');
  const favChips = $('#favChips');
  const vibrateToggle = $('#vibrateToggle');

  const MODE = { FOCUS: 'focus', REST: 'rest' };

  // ---- AudioContext: create once, unlock on first gesture, and reuse ----
  let audioCtx = null;
  function getAudioCtx(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return audioCtx;
  }
  function unlockAudio(){
    try {
      const ctx = getAudioCtx();
      if (ctx.state === 'suspended') ctx.resume();
    } catch(e){}
  }
  ['click','touchstart','keydown'].forEach(evt => {
    window.addEventListener(evt, unlockAudio, { once: false, passive: true });
  });

  // ---- counters ----
  function todayKey(kind){
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `crastina_${kind}_count_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function getCount(kind){
    const n = parseInt(localStorage.getItem(todayKey(kind))||'0',10);
    return isNaN(n)?0:n;
  }
  function bumpCount(kind){
    const k = todayKey(kind);
    let n = parseInt(localStorage.getItem(k)||'0',10); if (isNaN(n)) n = 0;
    n += 1; localStorage.setItem(k, String(n));
    renderCounters();
  }
  function renderCounters(){
    focusCountEl.textContent = `專注：${getCount('focus')} 次`;
    restCountEl.textContent = `休息：${getCount('rest')} 次`;
  }
  renderCounters();

  function setMode(mode){
    body.setAttribute('data-mode', mode);
    focusModeBtn.classList.toggle('active', mode===MODE.FOCUS);
    restModeBtn.classList.toggle('active', mode===MODE.REST);
    localStorage.setItem('crastina_mode', mode);
  }
  focusModeBtn.addEventListener('click', ()=> setMode(MODE.FOCUS));
  restModeBtn.addEventListener('click', ()=> setMode(MODE.REST));
  setMode(localStorage.getItem('crastina_mode') || MODE.FOCUS);

  // ---- shortcuts (fixed) ----
  function renderShortcuts(){
    shortcutsWrap.innerHTML = '';
    [5,8,15,30].forEach(m => addShortcutButton(m, shortcutsWrap));
  }
  function addShortcutButton(m, container){
    const b = document.createElement('button');
    b.className = 'sbtn';
    b.textContent = String(m);
    b.addEventListener('click', () => {
      mins.value = m; secs.value = 0;
      total = toSeconds(mins.value, secs.value);
      persist(); hideDone();
      unlockAudio();
      start(true);
    });
    container.appendChild(b);
  }
  renderShortcuts();

  // ---- favorites ----
  function loadFavs(){
    try { return JSON.parse(localStorage.getItem('crastina_favorites')||'[]'); } catch(_){ return []; }
  }
  function saveFavs(arr){
    localStorage.setItem('crastina_favorites', JSON.stringify(arr));
  }
  function renderFavs(){
    favChips.innerHTML = '';
    const favs = loadFavs();
    favs.forEach((m, idx) => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = `<span>${m} 分</span> <span class="rm" title="移除" aria-label="移除">✕</span>`;
      chip.addEventListener('click', (e) => {
        if (e.target.classList.contains('rm')) {
          const next = loadFavs().filter((_,i)=>i!==idx);
          saveFavs(next); renderFavs();
        } else {
          mins.value = m; secs.value = 0;
          total = toSeconds(mins.value, secs.value);
          persist(); hideDone(); unlockAudio(); start(true);
        }
      });
      favChips.appendChild(chip);
    });
  }
  renderFavs();
  favAddBtn.addEventListener('click', () => {
    const v = parseInt(favInput.value, 10);
    if (!v || v < 1 || v > 240) { favInput.focus(); return; }
    const favs = loadFavs();
    if (favs.includes(v)) { favInput.value = ''; return; }
    if (favs.length >= 6) favs.shift();
    favs.push(v); saveFavs(favs); favInput.value=''; renderFavs();
  });

  // ---- vibration toggle ----
  const vibPrefKey = 'crastina_vibrate';
  vibrateToggle.checked = localStorage.getItem(vibPrefKey) === '1';
  vibrateToggle.addEventListener('change', ()=> localStorage.setItem(vibPrefKey, vibrateToggle.checked ? '1' : '0'));

  let total = toSeconds(mins.value, secs.value);
  let timer = null;
  let running = false;

  const saved = localStorage.getItem('crastina_timer_last_v32');
  if (saved) {
    try {
      const {m, s} = JSON.parse(saved);
      mins.value = clamp(parseInt(m)||0, 0, 999);
      secs.value = clamp(parseInt(s)||0, 0, 59);
      total = toSeconds(mins.value, secs.value);
      render();
    } catch(_){}
  } else { persist(); }

  mins.addEventListener('change', () => { mins.value = clamp(mins.value,0,999); total = toSeconds(mins.value, secs.value); render(); persist(); hideDone(); });
  secs.addEventListener('change', () => { secs.value = clamp(secs.value,0,59); total = toSeconds(mins.value, secs.value); render(); persist(); hideDone(); });

  startPauseBtn.addEventListener('click', () => { unlockAudio(); if (!running) start(); else pause(); });
  soundTestBtn.addEventListener('click', () => { unlockAudio(); beep(body.getAttribute('data-mode')); });

  function start(fresh=false){
    hideDone();
    if (fresh) { total = toSeconds(mins.value, secs.value); }
    if (total <= 0) total = toSeconds(mins.value, secs.value);
    clearInterval(timer);
    running = true;
    startPauseBtn.textContent = '暫停';
    statusText.textContent = '倒數中…';
    tick(); timer = setInterval(tick, 1000);
  }
  function pause(){
    running = false;
    startPauseBtn.textContent = 'CRASTINA';
    statusText.textContent = '已暫停';
    if (timer) clearInterval(timer);
  }
  function tick(){
    if (total <= 0){
      pause();
      statusText.textContent = '完成';
      render();
      const mode = body.getAttribute('data-mode');
      try {
        if (localStorage.getItem(vibPrefKey) === '1' && navigator.vibrate) {
          navigator.vibrate([220, 100, 220, 80, 300]);
        }
      } catch(_) {}
      beep(mode);
      bumpCount(mode);
      showDone();
      return;
    }
    total -= 1; render();
  }
  function render(hint){
    timeText.textContent = format(total);
    if (hint) statusText.textContent = hint;
    document.title = timeText.textContent + ' • Crastina Timer v3.2';
  }

  function toSeconds(m,s){ m = clamp(parseInt(m)||0,0,999); s = clamp(parseInt(s)||0,0,59); return m*60 + s; }
  function format(sec){ const m = Math.floor(sec/60); const s = sec % 60; const hh = Math.floor(m/60); const mm = m%60; if (hh>0) return `${pad(hh)}:${pad(mm)}:${pad(s)}`; return `${pad(mm)}:${pad(s)}`; }
  function pad(n){ return String(n).padStart(2,'0'); }
  function clamp(n,min,max){ n = Number(n); if (isNaN(n)) return min; return Math.max(min, Math.min(max, n)); }
  function persist(){ localStorage.setItem('crastina_timer_last_v32', JSON.stringify({m: mins.value, s: secs.value})); }

  // Dual chime with persistent AudioContext
  function beep(mode){
    const ctx = getAudioCtx();
    try { if (ctx.state === 'suspended') ctx.resume(); } catch(_){}
    const now = ctx.currentTime;
    const baseAsc = [880, 1000, 1120];
    const baseDesc = baseAsc.slice().reverse();
    const seq = (mode === 'rest') ? baseDesc : baseAsc;
    const pattern = [0, 0.18, 0.36, 0.9, 1.08, 1.26];
    pattern.forEach((t, i) => {
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      const f = seq[i % 3];
      o.type = 'sine';
      o.frequency.value = f;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, now + t);
      g.gain.exponentialRampToValueAtTime(0.22, now + t + 0.03);
      g.gain.exponentialRampToValueAtTime(0.0001, now + t + 0.14);
      o.start(now + t); o.stop(now + t + 0.3);
    });
  }

  function showDone(){ doneWrap.classList.add('show'); }
  function hideDone(){ doneWrap.classList.remove('show'); }
})();
</script>
</body>
</html>
